<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Docker 镜像详解 | Bzm 文档✍</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/qianzai/mydocs@master/custom/_media/favicon.ico">
    <meta name="description" content="记录一路走来学习的计算机知识，构建自己的知识体系！">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.8ea9151f.css" as="style"><link rel="preload" href="/assets/js/app.50041b6b.js" as="script"><link rel="preload" href="/assets/js/3.67e4e7c7.js" as="script"><link rel="preload" href="/assets/js/1.4b78180f.js" as="script"><link rel="preload" href="/assets/js/9.be60b877.js" as="script"><link rel="preload" href="/assets/js/32.e67bc581.js" as="script"><link rel="prefetch" href="/assets/js/10.3d7e14e8.js"><link rel="prefetch" href="/assets/js/100.6067fcdb.js"><link rel="prefetch" href="/assets/js/101.3208727a.js"><link rel="prefetch" href="/assets/js/102.059125ef.js"><link rel="prefetch" href="/assets/js/103.5b3050c9.js"><link rel="prefetch" href="/assets/js/104.83449a53.js"><link rel="prefetch" href="/assets/js/105.35a4332d.js"><link rel="prefetch" href="/assets/js/106.830e8d65.js"><link rel="prefetch" href="/assets/js/107.7f2426e6.js"><link rel="prefetch" href="/assets/js/108.aabc04fe.js"><link rel="prefetch" href="/assets/js/109.3cc10333.js"><link rel="prefetch" href="/assets/js/11.c70ee217.js"><link rel="prefetch" href="/assets/js/110.0c05ea58.js"><link rel="prefetch" href="/assets/js/111.683e87a3.js"><link rel="prefetch" href="/assets/js/112.fe63e0be.js"><link rel="prefetch" href="/assets/js/113.bbe37571.js"><link rel="prefetch" href="/assets/js/114.7e76cacf.js"><link rel="prefetch" href="/assets/js/115.0a4512a7.js"><link rel="prefetch" href="/assets/js/116.fa23892a.js"><link rel="prefetch" href="/assets/js/117.c1b38dbc.js"><link rel="prefetch" href="/assets/js/118.5a97d59c.js"><link rel="prefetch" href="/assets/js/119.61bb550a.js"><link rel="prefetch" href="/assets/js/12.7d15bd7b.js"><link rel="prefetch" href="/assets/js/120.b32d6891.js"><link rel="prefetch" href="/assets/js/121.6b4129e3.js"><link rel="prefetch" href="/assets/js/122.6d8a4717.js"><link rel="prefetch" href="/assets/js/123.b9955c7e.js"><link rel="prefetch" href="/assets/js/124.578d76ea.js"><link rel="prefetch" href="/assets/js/125.cb24bcdc.js"><link rel="prefetch" href="/assets/js/126.c4972d34.js"><link rel="prefetch" href="/assets/js/127.fdb781d0.js"><link rel="prefetch" href="/assets/js/128.648b566b.js"><link rel="prefetch" href="/assets/js/129.c51277fa.js"><link rel="prefetch" href="/assets/js/13.f437198f.js"><link rel="prefetch" href="/assets/js/130.aabde2ca.js"><link rel="prefetch" href="/assets/js/131.693d96fb.js"><link rel="prefetch" href="/assets/js/132.20bc3774.js"><link rel="prefetch" href="/assets/js/133.36b95147.js"><link rel="prefetch" href="/assets/js/134.63fc322a.js"><link rel="prefetch" href="/assets/js/135.af647793.js"><link rel="prefetch" href="/assets/js/136.eaff6734.js"><link rel="prefetch" href="/assets/js/137.3595858c.js"><link rel="prefetch" href="/assets/js/14.aacc1bef.js"><link rel="prefetch" href="/assets/js/15.6ed84122.js"><link rel="prefetch" href="/assets/js/16.272f9fd4.js"><link rel="prefetch" href="/assets/js/17.c8741e7e.js"><link rel="prefetch" href="/assets/js/18.0db39702.js"><link rel="prefetch" href="/assets/js/19.9917f57f.js"><link rel="prefetch" href="/assets/js/20.b51db17b.js"><link rel="prefetch" href="/assets/js/21.36937019.js"><link rel="prefetch" href="/assets/js/22.9f21d273.js"><link rel="prefetch" href="/assets/js/23.d17b548b.js"><link rel="prefetch" href="/assets/js/24.52925684.js"><link rel="prefetch" href="/assets/js/25.25e3231f.js"><link rel="prefetch" href="/assets/js/26.7722d10c.js"><link rel="prefetch" href="/assets/js/27.a2270927.js"><link rel="prefetch" href="/assets/js/28.0f015a53.js"><link rel="prefetch" href="/assets/js/29.a7aa088c.js"><link rel="prefetch" href="/assets/js/30.d06842e3.js"><link rel="prefetch" href="/assets/js/31.735fb736.js"><link rel="prefetch" href="/assets/js/33.dde61bce.js"><link rel="prefetch" href="/assets/js/34.81e8a827.js"><link rel="prefetch" href="/assets/js/35.21929737.js"><link rel="prefetch" href="/assets/js/36.cff6f01e.js"><link rel="prefetch" href="/assets/js/37.0011c30f.js"><link rel="prefetch" href="/assets/js/38.b597ef38.js"><link rel="prefetch" href="/assets/js/39.4654ec92.js"><link rel="prefetch" href="/assets/js/4.21bce330.js"><link rel="prefetch" href="/assets/js/40.794ceedd.js"><link rel="prefetch" href="/assets/js/41.a5d125d4.js"><link rel="prefetch" href="/assets/js/42.4e4120fd.js"><link rel="prefetch" href="/assets/js/43.1b442355.js"><link rel="prefetch" href="/assets/js/44.5c621338.js"><link rel="prefetch" href="/assets/js/45.a255b905.js"><link rel="prefetch" href="/assets/js/46.75b8d63e.js"><link rel="prefetch" href="/assets/js/47.e96567f5.js"><link rel="prefetch" href="/assets/js/48.cb7fdabb.js"><link rel="prefetch" href="/assets/js/49.14acc194.js"><link rel="prefetch" href="/assets/js/5.9a1d0f7d.js"><link rel="prefetch" href="/assets/js/50.a6b1de04.js"><link rel="prefetch" href="/assets/js/51.137e16a0.js"><link rel="prefetch" href="/assets/js/52.7c9541cf.js"><link rel="prefetch" href="/assets/js/53.bfab9f8e.js"><link rel="prefetch" href="/assets/js/54.2506e7a0.js"><link rel="prefetch" href="/assets/js/55.c2bc2cbf.js"><link rel="prefetch" href="/assets/js/56.2c8b26f5.js"><link rel="prefetch" href="/assets/js/57.4de87136.js"><link rel="prefetch" href="/assets/js/58.10bb30d4.js"><link rel="prefetch" href="/assets/js/59.445118aa.js"><link rel="prefetch" href="/assets/js/6.34c6ebf3.js"><link rel="prefetch" href="/assets/js/60.e92ac748.js"><link rel="prefetch" href="/assets/js/61.aff65467.js"><link rel="prefetch" href="/assets/js/62.3cd1e065.js"><link rel="prefetch" href="/assets/js/63.5c2e6ae1.js"><link rel="prefetch" href="/assets/js/64.3a46788b.js"><link rel="prefetch" href="/assets/js/65.49f4b07f.js"><link rel="prefetch" href="/assets/js/66.7609640b.js"><link rel="prefetch" href="/assets/js/67.5e32eeb5.js"><link rel="prefetch" href="/assets/js/68.6fdae9ea.js"><link rel="prefetch" href="/assets/js/69.fe9419c9.js"><link rel="prefetch" href="/assets/js/7.d41d4e27.js"><link rel="prefetch" href="/assets/js/70.ca80643e.js"><link rel="prefetch" href="/assets/js/71.9420a66a.js"><link rel="prefetch" href="/assets/js/72.de9e15aa.js"><link rel="prefetch" href="/assets/js/73.d2dcc572.js"><link rel="prefetch" href="/assets/js/74.03c38c70.js"><link rel="prefetch" href="/assets/js/75.79ee6e35.js"><link rel="prefetch" href="/assets/js/76.0339fd29.js"><link rel="prefetch" href="/assets/js/77.93497135.js"><link rel="prefetch" href="/assets/js/78.030f143c.js"><link rel="prefetch" href="/assets/js/79.631170b1.js"><link rel="prefetch" href="/assets/js/8.6783294f.js"><link rel="prefetch" href="/assets/js/80.8e6854d5.js"><link rel="prefetch" href="/assets/js/81.33e2dc0d.js"><link rel="prefetch" href="/assets/js/82.fc6d71c5.js"><link rel="prefetch" href="/assets/js/83.6e7167fd.js"><link rel="prefetch" href="/assets/js/84.dd940260.js"><link rel="prefetch" href="/assets/js/85.07ff4182.js"><link rel="prefetch" href="/assets/js/86.77a844df.js"><link rel="prefetch" href="/assets/js/87.2cf62316.js"><link rel="prefetch" href="/assets/js/88.01ed0e97.js"><link rel="prefetch" href="/assets/js/89.0104f798.js"><link rel="prefetch" href="/assets/js/90.4145b02a.js"><link rel="prefetch" href="/assets/js/91.61114c77.js"><link rel="prefetch" href="/assets/js/92.7a353fd5.js"><link rel="prefetch" href="/assets/js/93.9de9c295.js"><link rel="prefetch" href="/assets/js/94.c8ebfddd.js"><link rel="prefetch" href="/assets/js/95.45ee80db.js"><link rel="prefetch" href="/assets/js/96.2020619a.js"><link rel="prefetch" href="/assets/js/97.9c497fcb.js"><link rel="prefetch" href="/assets/js/98.5feee35c.js"><link rel="prefetch" href="/assets/js/99.61a68018.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ea9151f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Bzm 文档✍</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>记录一路走来学习的计算机知识，构建自己的知识体系！</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Bzm</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Bzm 文档✍" class="logo"> <span class="site-name">Bzm 文档✍</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/其他/" class="nav-link"><i class="undefined"></i>
  其他
</a></li><li class="dropdown-item"><!----> <a href="/categories/云计算/" class="nav-link"><i class="undefined"></i>
  云计算
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/categories/生活/" class="nav-link"><i class="undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/运维/" class="nav-link"><i class="undefined"></i>
  运维
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/qianzai" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="https://cdn.jsdelivr.net/gh/qianzai/mydocs@master/custom/_media/%E5%A4%B4%E5%83%8F.jpg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    Bzm
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>120</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>28</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/其他/" class="nav-link"><i class="undefined"></i>
  其他
</a></li><li class="dropdown-item"><!----> <a href="/categories/云计算/" class="nav-link"><i class="undefined"></i>
  云计算
</a></li><li class="dropdown-item"><!----> <a href="/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/categories/后端/" class="nav-link"><i class="undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/categories/生活/" class="nav-link"><i class="undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/categories/系统/" class="nav-link"><i class="undefined"></i>
  系统
</a></li><li class="dropdown-item"><!----> <a href="/categories/运维/" class="nav-link"><i class="undefined"></i>
  运维
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      联系
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/qianzai" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Docker容器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/dockerrong-qi/docker_mirror_explain.html" aria-current="page" class="active sidebar-link">Docker 镜像详解</a></li><li><a href="/docs/dockerrong-qi/harbor_migration.html" class="sidebar-link">Harbor迁移</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>&lt;++&gt;</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc></h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>Bzm</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">Docker 镜像详解</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>Bzm</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>9/8/2020</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>Docker</span><span class="tag-item" data-v-1ff7123e>K8S</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="docker-镜像详解"><a href="#docker-镜像详解" class="header-anchor">#</a> Docker 镜像详解</h1> <h2 id="_1-前言"><a href="#_1-前言" class="header-anchor">#</a> 1. 前言</h2> <p>在构建 Docker 容器时，应该尽量想办法获得体积更小的镜像。这是无论是去传输还是部署时，速度会更快！</p> <p><strong>下面是差不多包含了 Docker 所有命令的一张图</strong></p> <blockquote><p>从中可以看出，Docker 包含三个基本概念，分别是镜像（Image）、容器（Container）和仓库（Repository）。</p></blockquote> <p><img src="/assets/img/71366177-3d516a00-25dc-11ea-8eab-2e366dc0e900-1623379327731.2da0a027.png" alt="image"></p> <h2 id="_2-概念"><a href="#_2-概念" class="header-anchor">#</a> 2. 概念</h2> <blockquote><p>镜像是 Docker 运行容器的前提，仓库是存放镜像的场所，可见镜像更是 Docker 的核心。</p></blockquote> <ul><li><p>Docker 镜像可以看作是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数（如匿名卷、环境变量、用户等）。</p></li> <li><p>镜像不包含任何动态数据，其内容在构建之后也不会被改变。</p></li></ul> <p><strong>要想更深入的了解 Docker 镜像，最重要的概念就是镜像层(Layers)。</strong></p> <h3 id="_2-1-联合文件系统-union-filesystem"><a href="#_2-1-联合文件系统-union-filesystem" class="header-anchor">#</a> 2.1. 联合文件系统（Union Filesystem）</h3> <p>这就不得不说到<strong>Docker 联合文件系统</strong>(Union Filesystem)。<code>DockerHub</code>中绝大多数的镜像都是通过在 base 镜像中安装和配置需要的软件构建出来的。新镜像是从 base 镜像一层一层叠加生成的，每安装一个软件就等于在现有的镜像上增加一层。</p> <blockquote><p>Docker 镜像采用分层结构的<strong>好处就是共享资源。</strong></p></blockquote> <p><img src="/assets/img/20161027203243-1623379327731.5a33be5d.jpg" alt="20161027203243"></p> <blockquote><p>每一个镜像都可能依赖于由一个或多个下层的组成的另一个镜像。下层那个镜像是上层镜像的父镜像。</p></blockquote> <p>比如，我们从<code>DockerHub</code>拉取一个镜像</p> <p><img src="/assets/img/image-20210412152834703-1623379327732.202c0e3a.png" alt="image-20210412152834703"></p> <p><img src="/assets/img/image-20210412154612399-1623379327732.3d283248.png" alt="image-20210412154612399"></p> <blockquote><p>下载过程中，会输出获取镜像的每一层信息。</p></blockquote> <ul><li>当容器启动时，一个新的可写层被加载到镜像的顶部，这一层就叫<strong>容器层</strong>，容器层之下都叫<strong>镜像层</strong>。</li> <li>只有容器层是可写的，容器层下面的所有镜像层都是只读的。<strong>对容器的任何改动都只会发生在容器层中</strong>。</li></ul> <h3 id="_2-2-copy-on-write-特性"><a href="#_2-2-copy-on-write-特性" class="header-anchor">#</a> 2.2. copy-on-write 特性</h3> <ul><li>添加文件：在容器中创建文件时，新文件被添加到容器层中。</li> <li>读取文件：当在容器中读取某个文件时，Docker 会从上往下依次在各镜像层中查找此文件，一旦找到打开并读入内存。</li> <li>修改文件：在容器中修改已存在的文件时，Docker 会从上往下依次在各个镜像层中查找此文件，一旦找到立即将其复制到容器层中，然后才修改。</li> <li>删除文件：在容器中删除文件时，Docker 会从上往下依次在镜像层中找，找到后，会在容器层记录下此删除操作。</li></ul> <blockquote><p><code>copy-on-write</code> 特性说明容器层保存的是镜像变化的部分，不会对镜像本身进行任何修改。所以镜像可以被多个容器共享。</p></blockquote> <h3 id="_2-3-镜像与容器的关系"><a href="#_2-3-镜像与容器的关系" class="header-anchor">#</a> 2.3. 镜像与容器的关系</h3> <p>可以通过下图来理解 docker daemon、docker 镜像以及 docker 容器三者的关系。</p> <p><img src="/assets/img/71367251-76d7a480-25df-11ea-8170-83ccc12ac438-1623379327732.bfb61f7c.png" alt="image"></p> <ul><li><p>当由 ubuntu:14.04 镜像启动容器时，ubuntu:14.04 镜像的镜像层内容将作为容器的 rootfs。</p></li> <li><p>ubuntu:14.04 镜像的 json 文件，会由 docker daemon 解析，并提取出其中的容器执行入口 CMD 信息，以及容器进程的环境变量 ENV 信息，最终初始化容器进程。</p></li></ul> <h2 id="_3-docker-镜像制作"><a href="#_3-docker-镜像制作" class="header-anchor">#</a> 3. Docker 镜像制作</h2> <p>?&gt;制作 Docker 镜像有两种方式，一种是使用<code>docker commit</code>命令制作，一种是使用<code>Dockerfile</code>文件构建。这里就不具体介绍了。</p> <p><strong>对应 Docker 镜像，都要保证镜像尽可能小</strong>，可以从如下方面去优化。</p> <ul><li>基础镜像小</li> <li>层级尽量少</li> <li>去除不必要</li> <li>复用镜像层</li> <li>分阶段构建</li></ul> <h3 id="_3-1-层级尽量少"><a href="#_3-1-层级尽量少" class="header-anchor">#</a> 3.1. 层级尽量少</h3> <p>如使用 Dockerfile 构建镜像，以下面这个文件为例。</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> ubuntu<span class="token punctuation">:</span>14.04
<span class="token keyword">ADD</span> run.sh /
<span class="token keyword">VOLUME</span> /data
<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">&quot;./run.sh&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>联合文件系统对应的层次结构如下图所示</strong></p> <p><img src="/assets/img/image-20210611103620472.8d758edd.png" alt="image-20210611103620472"></p> <p><strong>在 docker1.10 后只有 RUN、COPY、ADD 指令会创建层</strong>，其他指令会创建临时的中间镜像，不会直接增加构建的镜像大小。在编写 Dockerfile 时，我们需要根据实际情况去合并一些指令，因为<strong>copy-on-write 特性</strong>，上面层的文件，如果和下面层有冲突或不同，它会复制下层文件，然后再修改。</p> <h3 id="_3-2-去除不必要"><a href="#_3-2-去除不必要" class="header-anchor">#</a> 3.2. 去除不必要</h3> <p>我们在使用<code>Dockerfile</code>构建过程中或手动构建后<code>commit</code>的过程中所产生的临时文件，比如源码包、编译过程中产生的日志文件、添加的包管理仓库、包管理缓存，以及构建过程中安装的一些当时又用过后没用的软件或工具。还有一些不需要容器运行时构建的文件，这些文件不应该打包到镜像里面，而应该通过容器卷的方式在运行时候去挂载。</p> <h3 id="_3-3-复用镜像层"><a href="#_3-3-复用镜像层" class="header-anchor">#</a> 3.3. 复用镜像层</h3> <ul><li>比如要基于一个 Ubuntu 镜像去构建 Nginx 镜像，我们只需要在 Ubuntu 镜像的基础上面做一些 Nginx 的安装配置工作，一个 Nginx 镜像工作就算制作完成了。</li> <li>优化镜像存储空间，假如我们有两个镜像，Tag1.0 镜像和 Tag2.0 镜像，我们如果以传统方式去传这两个镜像，每个镜像大概 130 多兆，但如果我们以分层的方式去存储两个镜像，我们通过下面两个紫色的才能共享，可以节约大量的空间，两个镜像加起来只需要 140 多兆的空间就可以存下来。这样一是节省了存储空间，二是可以减少网络上的开销，比如我们已经把下面镜像下载了，我们要去下载上面镜像的时候，我们只需要去下 10M 的部分。</li></ul> <p><img src="/assets/img/image-20210611103452988.c75485b4.png" alt="image-20210611103452988"></p> <h3 id="_3-4-分阶段构建"><a href="#_3-4-分阶段构建" class="header-anchor">#</a> 3.4. 分阶段构建</h3> <p>通过将构建过程分析，分成多个阶段来执行，后面的或者最终的构建可以使用前面构建的结果，而不需要所有的构建都包含到最终的镜像中。拿 nginx 构建来举个例子</p> <blockquote><p>Docker v17.05 开始支持多阶段构建 (<code>multistage builds</code>)。</p></blockquote> <p><strong>常规构建方式</strong></p> <p>创建用于<code>Dockerfile</code>构建的目录</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> build/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>准备如下文件</p> <p><img src="data:image/png;base64,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" alt="image-20210412174644579"></p> <p><a href="http://nginx.org/download/nginx-1.15.8.tar.gz" target="_blank" rel="noopener noreferrer">nginx-1.15.8.tar.gz<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> centos<span class="token punctuation">:</span>7
<span class="token keyword">COPY</span> yum.repo /etc/yum.repos.d
<span class="token keyword">ADD</span> nginx<span class="token punctuation">-</span>1.15.8.tar.gz /mnt
<span class="token keyword">WORKDIR</span> /mnt/nginx<span class="token punctuation">-</span>1.15.8
<span class="token keyword">RUN</span> rpmdb <span class="token punctuation">-</span><span class="token punctuation">-</span>rebuilddb &amp;&amp; yum install <span class="token punctuation">-</span>y gcc pcre<span class="token punctuation">-</span>devel zlib<span class="token punctuation">-</span>devel make &amp;&amp; yum clean all
<span class="token keyword">RUN</span> sed <span class="token punctuation">-</span>i <span class="token string">'s/CFLAGS=&quot;$CFLAGS -g&quot;/#CFLAGS=&quot;$CFLAGS -g&quot;/g'</span> auto/cc/gcc
<span class="token keyword">RUN</span> ./configure <span class="token punctuation">-</span><span class="token punctuation">-</span>prefix=/usr/local/nginx &amp;<span class="token punctuation">&gt;</span> /dev/null
<span class="token keyword">RUN</span> make &amp;<span class="token punctuation">&gt;</span> /dev/null
<span class="token keyword">RUN</span> make install &amp;<span class="token punctuation">&gt;</span> /dev/null
<span class="token keyword">EXPOSE</span> 80
<span class="token keyword">VOLUME</span> <span class="token punctuation">[</span><span class="token string">&quot;/usr/local/nginx/html&quot;</span><span class="token punctuation">]</span>
<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">&quot;/usr/local/nginx/sbin/nginx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-g&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;daemon off;&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>构建镜像</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker build -t nginx:v1 .
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image-20210412172704795-1623379327732.3a75c82e.png" alt="image-20210412172704795"></p> <blockquote><p>可以发现足足多了 103MB</p></blockquote> <p><strong>分阶段构建方式</strong></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> centos<span class="token punctuation">:</span>7 as build
<span class="token keyword">COPY</span> yum.repo /etc/yum.repos.d
<span class="token keyword">ADD</span> nginx<span class="token punctuation">-</span>1.15.8.tar.gz /mnt
<span class="token keyword">WORKDIR</span> /mnt/nginx<span class="token punctuation">-</span>1.15.8
<span class="token keyword">RUN</span> rpmdb <span class="token punctuation">-</span><span class="token punctuation">-</span>rebuilddb &amp;&amp; yum install <span class="token punctuation">-</span>y gcc pcre<span class="token punctuation">-</span>devel zlib<span class="token punctuation">-</span>devel make &amp;&amp; yum clean all &amp;&amp; sed <span class="token punctuation">-</span>i <span class="token string">'s/CFLAGS=&quot;$CFLAGS -g&quot;/#CFLAGS=&quot;$CFLAGS -g&quot;/g'</span> auto/cc/gcc &amp;&amp; ./configure <span class="token punctuation">-</span><span class="token punctuation">-</span>prefix=/usr/local/nginx &amp;<span class="token punctuation">&gt;</span> /dev/null &amp;&amp; make &amp;<span class="token punctuation">&gt;</span> /dev/null &amp;&amp; make install &amp;<span class="token punctuation">&gt;</span> /dev/null &amp;&amp; rm <span class="token punctuation">-</span>fr /mnt/nginx<span class="token punctuation">-</span>*

<span class="token keyword">FROM</span>  centos<span class="token punctuation">:</span>7
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=build /usr/local/nginx /usr/local/nginx
<span class="token keyword">EXPOSE</span> 80
<span class="token keyword">VOLUME</span> <span class="token punctuation">[</span><span class="token string">&quot;/usr/local/nginx/html&quot;</span><span class="token punctuation">]</span>
<span class="token keyword">CMD</span> <span class="token punctuation">[</span><span class="token string">&quot;/usr/local/nginx/sbin/nginx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-g&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;daemon off;&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>docker build -t nginx:v2 <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/assets/img/image-20210412175027913-1623379327732.069aa6c7.png" alt="image-20210412175027913"></p> <blockquote><p>惊人发现居然只比基础镜像多了 1MB！</p></blockquote> <hr></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/11/2022, 9:01:18 AM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/docs/dockerrong-qi/harbor_migration.html">
            Harbor迁移
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_1-前言" class="sidebar-link reco-side-_1-前言" data-v-70334359>1. 前言</a></li><li class="level-2" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_2-概念" class="sidebar-link reco-side-_2-概念" data-v-70334359>2. 概念</a></li><li class="level-3" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_2-1-联合文件系统-union-filesystem" class="sidebar-link reco-side-_2-1-联合文件系统-union-filesystem" data-v-70334359>2.1. 联合文件系统（Union Filesystem）</a></li><li class="level-3" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_2-2-copy-on-write-特性" class="sidebar-link reco-side-_2-2-copy-on-write-特性" data-v-70334359>2.2. copy-on-write 特性</a></li><li class="level-3" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_2-3-镜像与容器的关系" class="sidebar-link reco-side-_2-3-镜像与容器的关系" data-v-70334359>2.3. 镜像与容器的关系</a></li><li class="level-2" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_3-docker-镜像制作" class="sidebar-link reco-side-_3-docker-镜像制作" data-v-70334359>3. Docker 镜像制作</a></li><li class="level-3" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_3-1-层级尽量少" class="sidebar-link reco-side-_3-1-层级尽量少" data-v-70334359>3.1. 层级尽量少</a></li><li class="level-3" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_3-2-去除不必要" class="sidebar-link reco-side-_3-2-去除不必要" data-v-70334359>3.2. 去除不必要</a></li><li class="level-3" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_3-3-复用镜像层" class="sidebar-link reco-side-_3-3-复用镜像层" data-v-70334359>3.3. 复用镜像层</a></li><li class="level-3" data-v-70334359><a href="/docs/dockerrong-qi/docker_mirror_explain.html#_3-4-分阶段构建" class="sidebar-link reco-side-_3-4-分阶段构建" data-v-70334359>3.4. 分阶段构建</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 Bzm 文档✍
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:none;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:50px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div></div></div>
    <script src="/assets/js/app.50041b6b.js" defer></script><script src="/assets/js/3.67e4e7c7.js" defer></script><script src="/assets/js/1.4b78180f.js" defer></script><script src="/assets/js/9.be60b877.js" defer></script><script src="/assets/js/32.e67bc581.js" defer></script>
  </body>
</html>
